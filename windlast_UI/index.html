<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Windlast · UI</title>
  <style>
    html, body { height: 100%; }
    body {
      margin: 0;
      display: grid;
      grid-template-rows: 80px 1fr 1fr;
      min-height: 100vh;
      background: var(--bg);
      color: var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    .slot { min-height: 0; }
    .slot > iframe { width:100%; height:100%; border:0; display:block; }
  </style>
  <link rel="stylesheet" href="static/css/style.css">
  <script src="static/js/theme.js"></script>
</head>
<body>
  <div class="slot">
    <iframe src="partials/header.html" title="Header" data-theme-sync></iframe>
  </div>
  <div class="slot">
    <iframe src="partials/konstruktionen/wrapper.html" title="Konstruktionen" data-theme-sync></iframe>
  </div>
  <div class="slot">
    <iframe src="partials/footer.html" title="Ergebnisse" data-theme-sync></iframe>
  </div>
  <script>
    // Map API-Normkeys -> Footer-ID-Suffix
    const NORM_ID = {
      "EN_13814_2005": "en13814_2005",
      "EN_17879_2024": "en17879_2024",
      "EN_1991_1_4_2010": "en1991_2010",
    };

    function forwardResultsToFooter(payload) {
      const footer = document.querySelector('iframe[src*="partials/footer.html"]');
      footer?.contentWindow?.postMessage({ type: "results/update", payload }, "*");
    }

    window.addEventListener("message", (ev) => {
      const msg = ev.data;
      if (!msg || typeof msg !== "object") return;

      if (msg.type === "results" && msg.source === "tor") {
        forwardResultsToFooter(msg.payload);
      }
      if (msg.type === "toast") {
        console[msg.payload?.level === "error" ? "error" : "log"](msg.payload?.text);
      }
    });
  </script>
  <script>
    (function(){
      // stabile ID pro Tab/Fenster
      const KEY = 'windlast_client_id';
      let id = sessionStorage.getItem(KEY);
      if (!id) { id = crypto.randomUUID(); sessionStorage.setItem(KEY, id); }

      function send(event){
        const payload = JSON.stringify({ event, id, t: Date.now() });
        // robust: Beacon, sonst fetch(keepalive)
        try {
          const blob = new Blob([payload], { type: 'application/json' });
          if (navigator.sendBeacon && navigator.sendBeacon('/__client_event', blob)) return;
        } catch {}
        fetch('/__client_event', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: payload,
          keepalive: true
        }).catch(()=>{});
      }

      // beim Laden anmelden
      window.addEventListener('pageshow', () => send('open'), { once: true });

      // alle 3s Heartbeat – falls "close" verschluckt wird
      const hb = setInterval(() => send('beat'), 3000);

      // beim Schließen abmelden (mehrere Events, je nach Browser)
      const bye = () => { try { clearInterval(hb); } catch {} send('close'); };
      window.addEventListener('pagehide', bye);
      window.addEventListener('beforeunload', bye);
    })();
    </script>
    </body>
</html>
